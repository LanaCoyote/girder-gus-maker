'use strict';

const game = window.game;

const Gus = require('./gus');
const GhostGirderMarker = require('./ghostGirderMarker');
const ParticleBurst = require("../particles/burst");

const COLLISION_GROUPS = require("../consts/collisionGroups");
const EPSILON = require("../consts").EPSILON;
const TAU = require("../consts").TAU;

class GhostGus extends Gus {
  constructor(x, y) {
    super(x, y, false);
    this.sprite.alpha = 0.5;

    this.startTime = game.time.now + 500;
    this.timingTolerance = -20; // in ms


    this.inputRecords = [{"INPUT":[2],"ENDTIME":14890},{"INPUT":[0],"ENDTIME":13690},{"INPUT":[1],"ENDTIME":13673},{"INPUT":[0],"ENDTIME":12905},{"INPUT":[2],"ENDTIME":12889},{"INPUT":[0],"ENDTIME":12522},{"INPUT":[1],"ENDTIME":12105},{"INPUT":[0],"ENDTIME":11755},{"INPUT":[2],"ENDTIME":11722},{"INPUT":[0],"ENDTIME":10588},{"INPUT":[2],"ENDTIME":10321},{"INPUT":[0],"ENDTIME":10221},{"INPUT":[2],"ENDTIME":10138},{"INPUT":[0],"ENDTIME":9554},{"INPUT":[1],"ENDTIME":9187},{"INPUT":[0],"ENDTIME":8904},{"INPUT":[2],"ENDTIME":8870},{"INPUT":[0],"ENDTIME":7903},{"INPUT":[1],"ENDTIME":7603},{"INPUT":[0],"ENDTIME":7320},{"INPUT":[2],"ENDTIME":7286},{"INPUT":[0],"ENDTIME":6903},{"INPUT":[1],"ENDTIME":6619},{"INPUT":[0],"ENDTIME":6353},{"INPUT":[2],"ENDTIME":6336},{"INPUT":[0],"ENDTIME":1600}];


    this.currentInputRecord = this.inputRecords.pop();
    this.currentInputRecord.hasBeenExecuted = false;

    this.courseCorrectionRecords = [[397.10689544677734,-1899.2388916015625],[397.17342376708984,-1770.3181457519531],[397.23995208740234,-1645.0337219238281],[397.30648040771484,-1523.4117126464844],[397.37300872802734,-1405.4774475097656],[397.43953704833984,-1291.25732421875],[397.50606536865234,-1180.7772827148438],[397.57259368896484,-1074.063949584961],[397.63912200927734,-971.1436462402344],[397.70565032958984,-872.0432281494141],[397.77217864990234,-776.78955078125],[397.83870697021484,-685.4096221923828],[397.90523529052734,-597.930908203125],[397.97176361083984,-514.3808746337891],[398.03829193115234,-434.78721618652344],[398.10482025146484,-359.17781829833984],[398.17134857177734,-287.5807571411133],[398.23787689208984,-220.02431869506836],[398.30440521240234,-156.53697967529297],[398.37093353271484,-97.14742660522461],[398.43746185302734,-41.88453674316406],[398.50399017333984,9.222594499588013],[398.57051849365234,56.144676208496094],[398.63704681396484,98.85221481323242],[398.70357513427734,137.31550216674805],[398.77010345458984,171.5045928955078],[398.83663177490234,201.38935089111328],[398.90316009521484,226.9394874572754],[398.96968841552734,248.12442779541016],[399.03621673583984,264.91336822509766],[399.10274505615234,277.27535247802734],[399.16927337646484,285.1791763305664],[399.23580169677734,288.5934257507324],[399.30233001708984,287.4864387512207],[399.36885833740234,281.82634353637695],[399.43538665771484,271.58103942871094],[405.6800079345703,256.71825408935547],[422.3174285888672,291.7368507385254],[438.95484924316406,322.4570083618164],[455.59226989746094,348.84838104248047],[472.2296905517578,370.8804702758789],[488.8671112060547,388.5226058959961],[505.50453186035156,401.7437744140625],[522.1419525146484,410.51280975341797],[538.7793731689453,414.7983932495117],[555.3834533691406,414.7843933105469],[571.9541931152344,412.4326705932617],[576.1177062988281,409.88216400146484],[576.1516571044922,409.8478317260742],[576.251106262207,409.7474670410156],[576.5417098999023,409.45396423339844],[577.3915863037109,408.5955810546875],[574.5555114746094,411.46228790283203],[560.7643890380859,428.0997085571289],[551.1539840698242,440.5944061279297],[545.7537460327148,423.9569854736328],[544.593391418457,407.3362350463867],[545.555305480957,390.76549530029297],[548.6954879760742,374.17808532714844],[550.1211547851562,373.03287506103516],[550.1618194580078,373.03287506103516],[550.2807998657227,373.03287506103516],[550.6287002563477,373.03287506103516],[551.6461563110352,373.03287506103516],[544.105339050293,386.3759994506836],[527.4679183959961,400.3676223754883],[523.3251953125,409.91260528564453],[539.9626159667969,414.97955322265625],[556.5666961669922,415.81966400146484],[573.1374359130859,415.7979965209961],[589.6748352050781,415.72757720947266],[606.2122344970703,415.5316925048828],[610.3745651245117,415.77491760253906],[610.378532409668,415.65242767333984],[610.3824996948242,415.2538299560547],[610.3864669799805,413.9568328857422],[610.3894424438477,409.888916015625],[610.3894424438477,409.8675537109375],[610.3894424438477,409.8051071166992],[610.3894424438477,409.6224594116211],[610.3894424438477,409.0884017944336],[610.3894424438477,407.52662658691406],[624.3548965454102,419.5943832397461],[633.9070510864258,432.07244873046875],[638.9812088012695,419.5943832397461],[639.829216003418,402.9903030395508],[639.829216003418,386.41956329345703],[639.829216003418,369.88216400146484],[639.829216003418,353.34476470947266],[639.829216003418,336.82403564453125],[639.829216003418,320.28663635253906],[639.829216003418,303.76590728759766],[639.829216003418,287.22850799560547],[639.829216003418,270.70777893066406],[639.829216003418,254.17037963867188],[639.829216003418,237.64965057373047],[639.829216003418,221.0955810546875],[639.829216003418,204.59152221679688],[639.829216003418,188.0374526977539],[639.829216003418,171.53339385986328],[639.829216003418,154.97931480407715],[639.829216003418,150.85329055786133],[639.829216003418,150.85329055786133],[639.829216003418,150.85329055786133],[639.829216003418,150.85329055786133],[639.829216003418,138.47521781921387],[639.829216003418,129.96185302734375],[639.829216003418,129.96185302734375],[639.8291397094727,113.44108581542969],[639.8289489746094,96.90366744995117],[639.8283767700195,80.38290023803711],[639.8263168334961,63.84547233581543],[639.8196792602539,47.32470989227295],[639.7981643676758,30.78728199005127],[639.7281646728516,14.266523122787476],[639.5005035400391,-2.287569046020508],[639.2544555664062,-14.732304811477661],[637.9589462280273,-14.732304811477661],[633.8967132568359,-14.732304811477661],[633.890495300293,-14.732304811477661],[633.8722991943359,-14.732304811477661],[633.8190460205078,-14.732304811477661],[633.6632919311523,-14.732304811477661],[633.207893371582,-14.732304811477661],[632.6145172119141,-20.07673978805542],[632.1421051025391,-27.849788665771484],[640.4608154296875,-31.567246913909912],[623.873405456543,-31.83344602584839],[607.3026657104492,-31.83344602584839],[590.7819366455078,-31.833443641662598],[574.2445373535156,-31.833438873291016],[557.7238082885742,-31.833419799804688],[541.1697387695312,-31.833360195159912],[524.6656799316406,-31.833157539367676],[508.11161041259766,-31.83250904083252],[491.60755157470703,-31.830389499664307],[475.05348205566406,-31.82349681854248],[458.54942321777344,-31.801066398620605],[445.9175491333008,-31.728084087371826],[429.3968200683594,-31.490607261657715],[412.8427505493164,-30.718846321105957],[404.54071044921875,-28.45719575881958],[404.54071044921875,-25.895848274230957],[404.54071044921875,-25.887856483459473],[404.54071044921875,-25.864486694335938],[404.54071044921875,-25.796148777008057],[404.54071044921875,-25.596301555633545],[404.54071044921875,-25.011892318725586],[401.43470764160156,-23.62285614013672],[391.4934539794922,-40.260276794433594],[385.7600402832031,-40.22700309753418],[384.26414489746094,-23.606247901916504],[384.48402404785156,-7.035489082336426],[385.1995086669922,9.518603086471558],[387.54547119140625,26.03936195373535],[390.1009750366211,30.19871711730957],[390.1028823852539,30.19871711730957],[390.1083755493164,30.19871711730957],[390.12447357177734,30.19871711730957],[390.1715850830078,30.19871711730957],[390.3092956542969,30.19871711730957],[390.7119369506836,30.19871711730957],[391.5695571899414,34.356205463409424],[374.93213653564453,48.35496425628662],[362.470703125,57.907094955444336],[379.1081237792969,62.98125743865967],[395.7122039794922,63.82922172546387],[412.28294372558594,63.82908344268799],[428.8203430175781,63.828630447387695],[445.34107208251953,63.827152252197266],[461.8784713745117,63.822340965270996],[478.4158706665039,63.80669116973877],[494.9365997314453,63.75577449798584],[511.4739990234375,63.59009265899658],[527.9947280883789,63.05098056793213],[535.8113098144531,61.29702091217041],[544.1133499145508,57.88663387298584],[544.1133499145508,57.886576652526855],[544.1133499145508,57.88651943206787],[544.1133499145508,57.88231372833252],[544.1133499145508,57.84828186035156],[544.1133499145508,57.74874210357666],[544.1228103637695,57.45767116546631],[544.1666412353516,56.6064977645874],[544.1666412353516,68.95651817321777],[544.1666412353516,85.46061515808105],[544.1666412353516,102.01469421386719],[544.1666412353516,118.51879119873047],[544.1666412353516,135.07287979125977],[544.1666412353516,151.57697677612305],[544.1666412353516,168.13104629516602],[544.1666412353516,184.63510513305664],[544.1667175292969,201.1891746520996],[544.1670608520508,217.69323348999023],[544.1681289672852,230.3609848022461],[544.1716766357422,246.86504364013672],[544.1831970214844,263.4191131591797],[544.2206573486328,279.9231719970703],[544.3425369262695,296.4772415161133],[544.7392272949219,312.9813003540039],[546.0300064086914,329.5353698730469],[550.1008224487305,340.7304000854492],[550.1023101806641,340.7304000854492],[550.1067733764648,340.7304000854492],[550.1198577880859,340.7304000854492],[550.1580810546875,340.7304000854492],[550.269775390625,340.7304000854492],[550.5965042114258,340.7304000854492],[551.5519332885742,340.7304000854492],[554.02587890625,337.6333236694336],[537.3884582519531,327.59403228759766],[520.7510375976562,321.7619323730469],[504.13028717041016,320.1666259765625],[487.5595474243164,320.1666259765625],[471.00547790527344,320.1666259765625],[454.5014190673828,320.1666259765625],[437.94734954833984,320.1666259765625],[421.42662048339844,320.1666259765625],[404.88922119140625,320.1666259765625],[388.36849212646484,320.1666259765625],[371.83109283447266,320.1666259765625],[355.31036376953125,320.1666259765625],[338.77296447753906,320.1666259765625],[326.16565704345703,320.1666259765625],[309.62825775146484,320.1666259765625],[293.10752868652344,320.1666259765625],[276.60343170166016,320.1666259765625],[260.1493263244629,320.1666259765625],[243.67856979370117,320.1667022705078],[227.20779418945312,320.16693115234375],[210.67039489746094,320.1676940917969],[194.14966583251953,320.17017364501953],[177.61226654052734,320.17822265625],[161.07486724853516,320.20435333251953],[144.5541000366211,320.2894592285156],[128.00000190734863,320.16666412353516],[128.00000190734863,320.16666412353516],[128.00000190734863,320.16666412353516],[128.00000190734863,320.16666412353516],[128.00000190734863,320.16666412353516],[128.00000190734863,320.16666412353516],[128.00000190734863,320.16666412353516],[128.00000190734863,320.16666412353516],[128.00000190734863,320.16666412353516],[128.00000190734863,320.16666412353516],[128.00000190734863,320.16666412353516],[128.00000190734863,320.16666412353516],[128.00000190734863,320.16666412353516],[128.00000190734863,320.16666412353516],[128.00000190734863,320.16666412353516],[128.00000190734863,320.16666412353516],[128.00000190734863,320.1667785644531],[128.00000190734863,320.16719818115234],[128.00000190734863,320.1686477661133],[128.00000190734863,320.17322540283203],[128.00000190734863,320.18810272216797],[128.00000190734863,320.2363586425781]];

    this.currentCourseCorrectionRecord = this.courseCorrectionRecords.pop();
    this.framesSinceCourseCorrection = 0;

    this.setCollision();

    this.marker = new GhostGirderMarker();
    this.marker.setMaster(this);

    console.log('Ghost Gus (a.k.a girder ghost) created.')
  }

  correctCourse() {
    this.sprite.body.x = this.currentCourseCorrectionRecord[0];
    this.sprite.body.y = this.currentCourseCorrectionRecord[1];

    if (this.courseCorrectionRecords.length)
      this.currentCourseCorrectionRecord = this.courseCorrectionRecords.pop();
  }

  evaluateInputRecord() {

    if (this.currentInputRecord) {

      if (this.isRecordExpired() && this.currentInputRecord.hasBeenExecuted) {
        this.currentInputRecord = this.inputRecords.pop();
      }

      if (!this.currentInputRecord) return;

      this.currentInputRecord.INPUT.forEach(action => {
        switch (action) {
          case 1:
            this.walk('left');
            break;
          case 2:
            this.walk('right');
            break;
          case 3:
            this.marker.placeGirder();
            break;
          default:
            this.stop();
            break;
        }
      });

      this.currentInputRecord.hasBeenExecuted = true;
    }
  }

  getTime() {
    return game.time.now - this.startTime;
  }

  isRecordExpired() {
    const currentTime = this.getTime();
    const currentInputRecordEnd = this.currentInputRecord.ENDTIME;

    return currentTime >= currentInputRecordEnd - this.timingTolerance;
  }

  // diff from Gus's doom: doesn't unlock the dolly
  doom() {

    this.sprite.body.clearCollision();
    this.sprite.body.fixedRotation = false;

    this.sprite.body.velocity.x = Math.sin(this.rotation) * 250;
    this.sprite.body.velocity.y = Math.cos(this.rotation) * -250;

    this.sprite.body.angularVelocity = 30;
    //this.sprite.body.rotateRight( 360 );

  }

  setCollision() {
    this.sprite.body.setCollisionGroup(COLLISION_GROUPS.GHOST_PLAYER_SOLID);
    this.sprite.body.setCollisionGroup(COLLISION_GROUPS.GHOST_PLAYER_SENSOR, this.rotationSensor);
    this.sprite.body.collides([COLLISION_GROUPS.GHOST_BLOCK_ROTATE, COLLISION_GROUPS.BLOCK_SOLID, COLLISION_GROUPS.BLOCK_ROTATE, COLLISION_GROUPS.ITEM, COLLISION_GROUPS.SPIKES]);
  }

  update() {
    if (Math.abs(Math.cos(this.rotation)) > EPSILON) this.sprite.body.velocity.x = 0;
    else this.sprite.body.velocity.y = 0;
    this.evaluateInputRecord();


    // check to see if we're rotating
    if (this.rotating) {
      // stop all movement
      this.stop();
      this.sprite.body.velocity.y = 0;
      this.sprite.body.velocity.x = 0;

      // create a rotate tween
      if (this.rotateTween === undefined) {
        this.rotateTween = game.add.tween(this.sprite).to({
            rotation: this.targetRotation
          }, 300, Phaser.Easing.Default, true)
          .onComplete.add(function() {
            this.rotation = this.targetRotation % (TAU); // keep angle within 0-2pi
            this.finishRotation();
          }, this);
      }

    } else if (!this.isDead) {

      // do gravity
      this.applyGravity();

      if (this.rotationSensor.needsCollisionData) {
        this.setCollision();
        this.rotationSensor.needsCollisionData = false;
      }

      this.marker.update()

      if (!this.isTouching("down")) {
        this.fallTime += game.time.physicsElapsedMS;

        if (this.fallTime > this.killTime) {
          this.kill();
        }

      } else {
        this.fallTime = 0;
      }

    }


        // course correction
        if (this.framesSinceCourseCorrection === 3) {
          this.correctCourse();
          this.framesSinceCourseCorrection = 0;
        } else this.framesSinceCourseCorrection++;

  }
}

module.exports = GhostGus;
